<!DOCTYPE html>
{% assign lang = page.lang | default: "en" %}
<html lang="{{ lang }}">
  {% include head.html %}

  <body>
    {% include menu.html %}
    {{ content }}
    {% include footer.html %}

    <script src="https://cdn.rawgit.com/michalsnik/aos/2.1.1/dist/aos.js"></script>
    <script src="/simple-jekyll-search.js"></script>
    <script type="text/javascript">
     // CSS Animation
     AOS.init({
       once: true
     });

     // Company Search
     const placeholders = ['Ruby', 'Python', 'PHP', 'Java', 'TypeScript', 'React', 'Vue', 'AWS', 'Django', 'Rails'];

     // Durstenfeld Shuffle Algorithm
     // https://ja.wikipedia.org/wiki/フィッシャー–イェーツのシャッフル
     for (i=placeholders.length; 1<i ; i--) {
       j = Math.floor(Math.random() * i);
       [placeholders[j], placeholders[i-1]] = [placeholders[i-1], placeholders[j]];
     }

     let placeholder_text = "{{ site.data.translations['searchPlaceholder'][page.lang] }}";
     placeholder_text      += placeholders[0] + ", " + placeholders[1] + ", " + placeholders[2];
     document.getElementById("search-input").placeholder = placeholder_text;

     const searchTarget = "/search-{{ lang }}.json";
     const sjs = SimpleJekyllSearch({
       searchInput:          document.getElementById('search-input'),
       resultsContainer:     document.getElementById('search-results'),
       json:                 searchTarget,
       limit:                20,

       searchResultTemplate: '<li><a href="{url}">{title}</a> <small><small>{description}</small></small></li>',
       noResultsText:        '{{ site.data.translations["searchNoResults"][page.lang] }}',
       loadingText:          '{{ site.data.translations["searchLoading"][page.lang] }}',

       // descriptionを100文字にtruncate. 100文字以下ならundefinedを返す（何も変えない）
       templateMiddleware: function(prop, value, template) {
	 if (typeof value === 'string') {
	   const query = document.getElementById('search-input').value.trim();
	   if (query) {
	     const regex = new RegExp(escapeRegExp(query), 'i'); // ここでは1個だけにしてる
      
	     const matchResult = regex.exec(value); // exec()ならマッチ位置が取れる！
	     if (matchResult) {
               const matchIndex  = matchResult.index;
               const matchLength = matchResult[0].length;

               const contextLength = 50; // 前後50文字
        
               const start = Math.max(0, matchIndex - contextLength);
               const end = Math.min(value.length, matchIndex + matchLength + contextLength);
        
               let sliced = value.slice(start, end);
        
               // その後にハイライトをかける
               const highlightRegex = new RegExp(escapeRegExp(query), 'gi');
               sliced = sliced.replace(highlightRegex, '<mark>$&</mark>');
        
               // もし切り取ったのが完全じゃなければ「...」を付ける
               if (start > 0) {
		 sliced = '...' + sliced;
               }
               if (end < value.length) {
		 sliced = sliced + '...';
               }

               value = sliced;
	     }
	   }
	 }
  
	 if (prop === 'description' && typeof value === 'string') {
	   // ハイライトでタグも入るので、文字数は少し余裕を見る
	   if (value.length > 300) {
	     return value.substring(0, 300) + '...';
	   }
	 }
  
	 return value;
       }
     });

     // 正規表現エスケープ用の関数
     function escapeRegExp(string) {
       return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
     }
    </script>
  </body>
</html>
